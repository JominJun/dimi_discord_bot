import discord, random, os, sqlite3, pandas as pd
from discord.ext import commands

app = commands.Bot(command_prefix="$", status=discord.Status.online, activity=discord.Game("'$ëª…ë ¹ì–´' ëŒ€ê¸°"))
token = os.getenv('DISCORD_BOT_DIMI1538_TOKEN')
caller = ""
onActivity = ""
gamble_ans = 0

# DB ì—°ê²°
conn = sqlite3.connect("discord_bot_dimi1538.db")
cur = conn.cursor()

@app.event
async def on_ready():
    print(f"{app.user.name}({app.user.id})ì˜ ì‘ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤")

@app.event
async def on_message(message):
    if message.author.id != 755042267085013013:
        cur.execute(f"SELECT * FROM user WHERE id='{message.author.id}'")
        rows = cur.fetchall()
        now_point = rows[0][3]
        await app.process_commands(message)
        global caller, onActivity, gamble_ans
        if onActivity == "gamble":
            if message.content.startswith('*') and caller == message.author.display_name:
                try:
                    inp = int(str(message.content).split('*')[1])
                    if gamble_ans == inp:
                        await message.channel.send(f"ğŸ’¥âšœğŸŒŸğŸ¥‡ğŸ†ì •ë‹µì´ì•¼!ğŸ†ğŸ¥‡ğŸŒŸâšœğŸ’¥\ní¬ì¸íŠ¸ 5ì ì„ ì¶”ê°€í•´ì„œ {now_point}ì—ì„œ {now_point+5}ì ì´ ë˜ì—ˆì–´!")
                        cur.execute(f"UPDATE user SET gamblePoint={now_point+5} WHERE id='{message.author.id}'")
                        caller = ""
                        onActivity = ""
                        gamble_ans = ""
                    elif gamble_ans > inp:
                        await message.channel.send("ì¡°ê¸ˆ ë” í° ìˆ«ìì•¼..")
                    else:
                        await message.channel.send("ì¡°ê¸ˆ ë” ì‘ì€ ìˆ«ìì•¼..")
                except ValueError:
                    await message.channel.send("ì´ê±´ ìˆ«ìê°€ ì•„ë‹ˆì–ì•„;;...")

                conn.commit()

@app.command()
async def ëª…ë ¹ì–´(ctx):
    embed = discord.Embed(color=0xed1280)
    embed.set_author(name="1538 ë¯¼ì†Œí˜„ ëª…ë ¹ì–´", icon_url="https://imgur.com/krJM8Wj.png")
    embed.add_field(name="âœ… ê¸°ë³¸ì •ë³´", value="ì†Œí˜„ì´ë¥¼ ì†Œí™˜í•  ë•ŒëŠ” ì•ì— '$'ì„ ë¶™ì—¬ì„œ ì†Œí™˜í•©ë‹ˆë‹¤", inline=False)
    embed.add_field(name="ğŸ‰ ìœ ë˜", value="íƒì£¼ìŒ¤ì´...ì†Œì—°ì´ë¥¼ ì†Œí˜„ì´ë¼ ë¶ˆëŸ¬ì„œ...ë‚œ íƒœì–´ë‚¬ì–´..", inline=False)
    embed.add_field(name="$ëª…ë ¹ì–´", value="ëª…ë ¹ì–´ ëª©ë¡ì„ ë³´ì—¬ì¤„ê²Œ...ã…,,")
    embed.add_field(name="$ì†Œí˜„ì•„", value="ë‚´... ì´ë¦„.. ë¶ˆëŸ¬ì¤˜...")
    embed.add_field(name="$ë„ë°•", value="ë„.ë°•. ì´.ê±°. ì§„.ì§œ.ì¬.ë°Œ.ìŠµ.ë‹ˆ.ë‹¤.")
    embed.add_field(name="$ë‹¤ëŒì¥ë‹¤!", value="... ë‹¤ëŒì¥..?")
    embed.set_footer(text="ë‹´ë‹¹ì: â­ì¡°ë¯¼ì¤€")
    await ctx.send(embed=embed)

@app.command()
async def ì†Œí˜„ì•„(ctx):
    await ctx.send("í˜¹ì‹œ,, ë‚˜..ë¶€ë¥¸ê±°ì•¼...? ...")

@app.command(name="ë‹¤ëŒì¥ë‹¤!")
async def _squirrel(ctx):
    await ctx.send("ë¼ì•¼ì•„ì•™ì•„ì•„ê°€ê°€ê°€ê° ë‹¤ëŒì¥ëŠ” ë¬´ì„œì›Œ!!!!! ã… ã…œã… ã…œã… ã… ã…œã… ")

@app.command(name="ë„ë°•")
async def _gamble(ctx, *args):
    global caller, onActivity, gamble_ans
    bf_caller = caller
    if len(args):
        if args[0] == "ë„ì›€":
            embed = discord.Embed(color=0xed1280)
            embed.set_author(name="1í•™ë…„ 5ë°˜ ë„ë°• ë„ìš°ë¯¸", icon_url="https://imgur.com/krJM8Wj.png")
            embed.add_field(name="$ë„ë°• [ë„ì›€|ì‹œì‘|ì¤‘ì§€|ì •ë³´]", value="ë„ì›€ì´ ë˜ì—ˆê¸¸ ë°”ë¼,,", inline=False)
            embed.set_footer(text="ê°œë°œë‹´ë‹¹ì: â­ë„ë°•í•˜ì„¸ìš”")
            await ctx.send(embed=embed)
        elif args[0] == "ì‹œì‘":
            cur.execute(f"SELECT EXISTS(SELECT * FROM user WHERE id='{ctx.message.author.id}')")
            if cur.fetchone()[0]:
                if onActivity == "":
                    caller = ctx.message.author.display_name
                    onActivity = "gamble"
                    await ctx.send("í˜¹ì‹œ.. ë„ë°•..ã…ã…..ì•„ ë¯¸ì•ˆ...ë„ë°• ì•ˆí• ë˜?..\në‚´ê°€... ìˆ«ì(1~100)ë¥¼ ìƒê°í• í…Œë‹ˆê¹Œ... ë§í˜€ë´...ã…ã…\n*[ìˆ«ì]ë¡œ ë‚´ê²Œ ì…ë ¥í•´ì£¼ë©´ ë¼...ã…ã…\nê·¸ë§Œë‘ê³  ì‹¶ìœ¼ë©´...'$ë„ë°• ì¤‘ì§€'ë¼ê³  í•´")
                    gamble_ans = random.randint(1, 100)
                else:
                    await ctx.send(f"'{bf_caller}'ê°€ ë„ë°• ì¤‘ì¸ê²ƒ ê°™ì•„.. ëë‚´ê³  ì‹¶ìœ¼ë©´ ë„ë°•ì„ ì‹œì‘í•œ ì‚¬ëŒì´ ì •ë‹µì„ ë§íˆê±°ë‚˜ '$ë„ë°• ì¤‘ì§€'ë¥¼ ì‹¤í–‰í•´ì•¼ ë¼..")
            else:
                await ctx.send(f"{ctx.message.author.mention}ì”¨! ê°€ì…ì€ í•˜ê³  í•˜ì…”ì•¼ì§€~")

        elif args[0] == "ì¤‘ì§€":
            # ë„ë°•ì„ ì‹œì‘í–ˆëŠ”ì§€ ì²´í¬
            if caller == ctx.message.author.display_name:
                await ctx.send(f"ë„ë°•ì„ ì¤‘ë‹¨í–ˆì–´... ì •ë‹µì€ {gamble_ans}ì˜€ëŠ”ë° ì•„ì‰½ë„¤...ã…ã…...")
                caller = ""
                onActivity = ""
                gamble_ans = ""
            else:
                await ctx.send("ë„ë°• ì¢…ë£ŒëŠ” ì‹œì‘í•œ ì‚¬ëŒì´ í•  ìˆ˜ ìˆì–´")

        elif args[0] == "ê°€ì…":
            cur.execute(f"SELECT EXISTS(SELECT * FROM user WHERE id='{ctx.message.author.id}')")

            if cur.fetchone()[0]: # ê°€ì…í•œ ì‚¬ìš©ì
                await ctx.send("ë‹¹ì‹ ì€ ê°€ì…í•œ ì‚¬ìš©ìêµ°ìš”! ë„ë°•ì„ ì´ìš©í•˜ì„¸ìš”~")
            else:  # ê°€ì…í•˜ì§€ ì•Šì€ ì‚¬ìš©ì
                cur.execute(f"INSERT INTO user (id, nickname, gamblepoint) values('{ctx.message.author.id}', '{ctx.message.author.display_name}', 0)")
                cur.execute(f"SELECT EXISTS(SELECT * FROM user WHERE id='{ctx.message.author.id}')")

                if cur.fetchone()[0]:
                    await ctx.send(f"{ctx.message.author.mention}ì”¨,, ê°€ì… ì™„ë£Œí–ˆì–´ìš”")
                else:
                    await ctx.send(f"{ctx.message.author.mention}ì”¨,, ì˜¤ë¥˜ê°€ ë°œìƒí•œ..ë“¯..?.. ì£„ì†¡..í•´ìš”..")

                conn.commit()

        elif args[0] == "ì •ë³´":
            member = ctx.message.author
            if member is not None:
                cur.execute(f"SELECT * FROM user WHERE id='{ctx.message.author.id}'")
                rows = cur.fetchall()
                embed = discord.Embed(color=0xed1280)
                embed.set_author(name=f"'{rows[0][2]}'ë‹˜ì˜ ì •ë³´")
                embed.set_thumbnail(url=ctx.message.author.avatar_url)
                embed.add_field(name="ì•„ì´ë””", value=f"{rows[0][1]}")
                embed.add_field(name="ë³´ìœ  í¬ì¸íŠ¸", value=f"{rows[0][3]}ì ")
                await ctx.channel.send(embed=embed)

    else:
        await ctx.send("'$ë„ë°• ë„ì›€'ì„ ì…ë ¥í•˜ì—¬ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´,,,")

app.run(token)
